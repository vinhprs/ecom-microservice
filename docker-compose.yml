x-kong-config: &kong-env
  KONG_DATABASE: postgres
  KONG_PG_HOST: kong-database
  KONG_PG_DATABASE: kong
  KONG_PG_USER: kong
  KONG_PG_PASSWORD: kongpass
  KONG_PASSWORD: admin
  KONG_LICENSE_DATA: kpat_p6smrd41RY45JW1fL8r8h6YNlKnjGLI6p6f1DqpSR97A7Y2n2

services:
  # ==========================================
  # KONG API GATEWAY INFRASTRUCTURE
  # ==========================================

  # Kong Database (PostgreSQL)
  kong-database:
    image: postgres:16.3-alpine3.20
    container_name: kong-database
    environment:
      POSTGRES_DB: kong
      POSTGRES_USER: kong
      POSTGRES_PASSWORD: kongpass
    ports:
      - "5432:5432"
    volumes:
      - kong-db-data:/var/lib/postgresql/data
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "kong"]
      interval: 10s
      timeout: 5s
      retries: 5

  kong-migrations:
    image: kong/kong-gateway:3.12.0.1
    container_name: kong-migrations
    depends_on:
      kong-database:
        condition: service_healthy
    environment:
      <<: *kong-env
      KONG_PASSWORD: admin
    networks:
      - ecommerce-network
    command: kong migrations bootstrap

  kong-cp:
    image: kong/kong-gateway:3.12.0.1
    container_name: kong-cp
    restart: on-failure
    networks:
      - ecommerce-network
    environment:
      <<: *kong-env
      KONG_ADMIN_LISTEN: 0.0.0.0:8001, 0.0.0.0:8444 ssl
      KONG_ADMIN_GUI_LISTEN: 0.0.0.0:8002, 0.0.0.0:8445 ssl
      KONG_ADMIN_GUI_URL: http://${GW_HOST:-localhost}:8002
      KONG_PASSWORD: kongpass
      #Plugin
      KONG_PLUGINS: bundled,kong-jwt2header
    volumes:
      - kong-plugins:/usr/local/share/lua/5.1/kong/plugins
      - ./scripts/kong-jwt2header:/usr/local/share/lua/5.1/kong/plugins/kong-jwt2header
    depends_on:
      kong-migrations:
        condition: service_completed_successfully
    ports:
      - "8000:8000" # Proxy HTTP
      - "8443:8443" # Proxy HTTPS
      - "8001:8001" # Admin API HTTP
      - "8444:8444" # Admin API HTTPS
      - "8002:8002" # Kong Manager HTTP
      - "8445:8445" # Kong Manager HTTPS

  # ==========================================
  # AUTH DATABASE
  # ==========================================
  auth-database:
    image: postgres:16.3-alpine3.20
    container_name: auth-database
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: auth
      POSTGRES_PASSWORD: authpass
    ports:
      - "5433:5432"
    networks:
      - ecommerce-network
    volumes:
      - auth-db-data:/var/lib/postgresql/data

  # ==========================================
  # USERS SHARDING DATABASE
  # ==========================================
  users-shard-1:
    image: postgres:16.3-alpine3.20
    container_name: users-shard-1
    environment:
      POSTGRES_DB: users_shard_1
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5434:5432"
    volumes:
      - shard1_data:/var/lib/postgresql/data
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  users-shard-2:
    image: postgres:16.3-alpine3.20
    container_name: users-shard-2
    environment:
      POSTGRES_DB: users_shard_2
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5435:5432"
    volumes:
      - shard2_data:/var/lib/postgresql/data
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  users-shard-3:
    image: postgres:16.3-alpine3.20
    container_name: users-shard-3
    environment:
      POSTGRES_DB: users_shard_3
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5436:5432"
    volumes:
      - shard3_data:/var/lib/postgresql/data
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  users-shard-4:
    image: postgres:16.3-alpine3.20
    container_name: users-shard-4
    environment:
      POSTGRES_DB: users_shard_4
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5437:5432"
    volumes:
      - shard4_data:/var/lib/postgresql/data
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # USERS SHARDING DATABASE
  # ==========================================
  product-db-master:
    image: postgres:16.3-alpine3.20
    container_name: product-db-master
    environment:
      POSTGRES_DB: product_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      PGDATA: /var/lib/postgresql/data
    command: |
      postgres
        -c wal_level=replica
        -c hot_standby=on
        -c max_wal_senders=10
        -c max_replication_slots=10
    ports:
      - "5438:5432"
    networks:
      - ecommerce-network
    volumes:
      - ./scripts/replication/setup-master.sh:/docker-entrypoint-initdb.d/setup-master.sh
      - product-db-master-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  product-db-slave1:
    image: postgres:16.3-alpine3.20
    container_name: product-db-slave1
    environment:
      POSTGRES_DB: product_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      MASTER_HOST: product-db-master
      MASTER_PORT: 5432
      REPLICATION_USER: replicator
      REPLICATION_PASSWORD: replicator_password
      REPLICATION_SLOT: replication_slot1
      PGDATA: /var/lib/postgresql/data
    ports:
      - "5439:5432"
    networks:
      - ecommerce-network
    depends_on:
      product-db-master:
        condition: service_healthy
    volumes:
      - product-db-slave1-data:/var/lib/postgresql/data
      - ./scripts/replication/setup-slave.sh:/docker-entrypoint-initdb.d/setup-slave.sh:ro

  product-db-slave2:
    image: postgres:16.3-alpine3.20
    container_name: product-db-slave2
    environment:
      POSTGRES_DB: product_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      MASTER_HOST: product-db-master
      MASTER_PORT: 5432
      REPLICATION_USER: replicator
      REPLICATION_PASSWORD: replicator_password
      REPLICATION_SLOT: replication_slot2
      PGDATA: /var/lib/postgresql/data
    ports:
      - "5440:5432"
    networks:
      - ecommerce-network
    depends_on:
      product-db-master:
        condition: service_healthy
    volumes:
      - product-db-slave2-data:/var/lib/postgresql/data
      - ./scripts/replication/setup-slave.sh:/docker-entrypoint-initdb.d/setup-slave.sh:ro

  # ==========================================
  # BACKEND MICROSERVICES
  # ==========================================
  ecommerce-microservices:
    build:
      context: .
      dockerfile: apps/ecom-microservice/Dockerfile
    command: npm run start:dev ecom-microservice
    env_file:
      - ./apps/ecom-microservice/.env
    ports:
      - "3000:3000"
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - .:/usr/src/app

  auth-service:
    build:
      context: .
      dockerfile: apps/auth/Dockerfile
    command: npm run start:dev auth
    env_file:
      - ./apps/auth/.env
    ports:
      - "3001:3001"
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - .:/usr/src/app

  users-service:
    build:
      context: .
      dockerfile: apps/users/Dockerfile
    command: npm run start:dev users
    env_file:
      - ./apps/users/.env
    ports:
      - "3002:3002"
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3002/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - .:/usr/src/app

  products-service:
    build:
      context: .
      dockerfile: apps/products/Dockerfile
    command: npm run start:dev products
    env_file:
      - ./apps/products/.env
    ports:
      - "3003:3003"
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3003/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - .:/usr/src/app

  orders-service:
    build:
      context: .
      dockerfile: apps/orders/Dockerfile
    command: npm run start:dev orders
    env_file:
      - ./apps/orders/.env
    ports:
      - "3004:3004"
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3004/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - .:/usr/src/app

  notifications-service:
    build:
      context: .
      dockerfile: apps/notifications/Dockerfile
    command: npm run start:dev notifications
    env_file:
      - ./apps/notifications/.env
    ports:
      - "3005:3005"
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3005/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - .:/usr/src/app

  # ==========================================
  # AUTH REGISTER QUEUE
  # ==========================================
  rabbitmq:
    image: rabbitmq:4.1-management-alpine
    container_name: rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5672/health"]

networks:
  ecommerce-network:
    driver: bridge

volumes:
  kong-db-data:
    driver: local
  kong-plugins:
    driver: local
  auth-db-data:
    driver: local
  shard1_data:
    driver: local
  shard2_data:
    driver: local
  shard3_data:
    driver: local
  shard4_data:
    driver: local
  product-db-master-data:
    driver: local
  product-db-slave1-data:
    driver: local
  product-db-slave2-data:
    driver: local
  rabbitmq_data:
    driver: local
